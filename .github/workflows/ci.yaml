name: CI

on:
    push:
        branches: [ main ]

env:
    IMAGE_NAME: snapdock

jobs:
    build:
        name: Build (${{ matrix.suffix }})
        runs-on: ${{ matrix.runner }}
        timeout-minutes: 30

        permissions:
            packages: write
            contents: read

        strategy:
            matrix:
                include:
                  - platform: linux/amd64
                    runner: ubuntu-latest
                    suffix: amd64
                  - platform: linux/arm64
                    runner: ubuntu-24.04-arm
                    suffix: arm64

        steps:
          - name: Checkout
            uses: actions/checkout@v4

          - name: Set lowercase owner
            run: echo "OWNER=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

          - name: Log in to Registry
            run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

          - name: Set up Docker Buildx
            uses: docker/setup-buildx-action@v3

          - name: Build and push by digest
            id: build
            uses: docker/build-push-action@v6
            with:
              context: .
              platforms: ${{ matrix.platform }}
              outputs: type=image,name=ghcr.io/${{ env.OWNER }}/${{ env.IMAGE_NAME }},push-by-digest=true,name-canonical=true,push=true

          - name: Export digest
            run: |
              mkdir -p /tmp/digests
              digest="${{ steps.build.outputs.digest }}"
              touch "/tmp/digests/${digest#sha256:}"

          - name: Upload digest
            uses: actions/upload-artifact@v4
            with:
              name: digests-${{ matrix.suffix }}
              path: /tmp/digests/*
              if-no-files-found: error
              retention-days: 1

    merge:
        name: Merge & Publish
        runs-on: ubuntu-latest
        needs: build
        timeout-minutes: 10

        permissions:
            packages: write
            contents: read

        steps:
          - name: Download digests
            uses: actions/download-artifact@v4
            with:
              path: /tmp/digests
              pattern: digests-*
              merge-multiple: true

          - name: Set lowercase owner
            run: echo "OWNER=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

          - name: Log in to Registry
            run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

          - name: Set up Docker Buildx
            uses: docker/setup-buildx-action@v3

          - name: Create manifest and push
            working-directory: /tmp/digests
            run: |
              docker buildx imagetools create \
                -t ghcr.io/$OWNER/${{ env.IMAGE_NAME }}:${{ github.sha }} \
                -t ghcr.io/$OWNER/${{ env.IMAGE_NAME }}:latest \
                $(printf "ghcr.io/$OWNER/${{ env.IMAGE_NAME }}@sha256:%s " *)

          - name: Inspect image
            run: docker buildx imagetools inspect ghcr.io/$OWNER/${{ env.IMAGE_NAME }}:latest
